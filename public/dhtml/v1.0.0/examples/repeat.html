<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width" />
<title>repeat - dhtml</title>

<script type="module">
  import { define, html, refs, repeat } from '../dhtml.js';

  function shuffle(arr) {
    let a = arr.length;

    while (a > 0) {
      const b = Math.floor(Math.random() * a--);

      [arr[a], arr[b]] = [arr[b], arr[a]];
    }

    return arr;
  }

  const todoItemTemplate = html`
    <li ref="root">
      <span ref="text"></span>
      <input ref="done" type="checkbox" />
      <button ref="remove">Delete</button>
    </li>
  `;

  function TodoItem(item, scope) {
    const view = todoItemTemplate();
    const { root, text, done, remove } = refs(view);

    function update(nextItem = item) {
      text.textContent = nextItem.text;
      done.checked = nextItem.done;
      item = nextItem;
    }

    done.onclick = () => scope.toggle(item);
    remove.onclick = () => scope.remove(item);

    root.update = update;

    update();

    return root;
  }

  const todoAppTemplate = html`
    <input ref="input" type="text" />
    <button ref="reorder">reorder</button>
    <ul ref="todos"></ul>
  `;

  let nextId = 1;

  function TodoApp() {
    const view = todoAppTemplate();
    const { input, reorder, todos } = refs(view);
    let items = new Set();

    const scope = {
      add(value) {
        items.add({
          id: nextId++,
          text: value,
          done: false
        });

        update();
      },
      reorder() {
        items = new Set(shuffle([...items]));

        update();
      },
      toggle(item) {
        item.done = !item.done;

        update();
      },
      remove(item) {
        items.delete(item);

        update();
      }
    };

    function update() {
      repeat({
        items,
        key: 'id',
        parent: todos,
        create: item => TodoItem(item, scope),
        update: (el, item) => el.update(item)
      });
    }

    input.onkeypress = event => {
      if (event.key === 'Enter') {
        event.preventDefault();
        scope.add(input.value);
        input.value = '';
      }
    };

    reorder.onclick = event => {
      scope.reorder();
    };

    update();

    return view;
  }

  define('todo-app', TodoApp);
</script>

<style>
  @import '../docs/css/index.css';
</style>

<todo-app></todo-app>
